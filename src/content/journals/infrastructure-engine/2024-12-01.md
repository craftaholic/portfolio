---
title: NATS messaging setup
date: 2024-12-01
overview: Integrated NATS for async operations and real-time notifications.
---

## Why NATS

Infrastructure operations are inherently async. A Terraform apply can take minutes. Users shouldn't have to poll an API to check status.

NATS provides:
- Pub/sub for notifications
- Request/reply for sync operations
- JetStream for durable message queues

## Architecture

```
┌─────────┐     ┌──────┐     ┌──────────┐
│ API     │────▶│ NATS │────▶│ Workers  │
└─────────┘     └──────┘     └──────────┘
                   │
                   ▼
              ┌──────────┐
              │ Clients  │
              │ (SSE/WS) │
              └──────────┘
```

## Message Types

**Commands** (request/reply)
- `infra.plan.create` - Start a new plan
- `infra.apply.execute` - Apply an approved plan

**Events** (pub/sub)
- `infra.plan.completed` - Plan finished
- `infra.apply.started` - Apply in progress
- `infra.apply.completed` - Apply finished
- `infra.apply.failed` - Apply failed with error

## Implementation

Using NATS JetStream for durability:
- Messages survive broker restarts
- At-least-once delivery guarantee
- Consumer groups for worker scaling

## Client Integration

Added Server-Sent Events (SSE) endpoint that subscribes to NATS and streams updates to the browser. Clients connect once and receive all relevant updates in real-time.
