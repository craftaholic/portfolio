---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductArticle from '../../components/products/ProductArticle.astro';
import Comments from '../../components/blog/Comments.astro';
import JournalOverlay from '../../components/products/JournalOverlay.astro';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';

interface JournalEntry {
  id: string;
  date: string;
  title: string;
  overview: string;
  Content: AstroComponentFactory;
}

interface Props {
  entry: CollectionEntry<'products'>;
  journals: JournalEntry[];
}

export async function getStaticPaths() {
  const products = await getCollection('products');
  const allJournals = await getCollection('journals');

  return await Promise.all(products.map(async (entry) => {
    // Get journals for this product (derived from directory: journals/{product}/{date}.md)
    const productJournals = allJournals
      .filter(j => j.id.startsWith(entry.id + '/'))
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

    // Render each journal's markdown content
    const journals = await Promise.all(productJournals.map(async (journal) => {
      const { Content } = await render(journal);
      return {
        id: journal.id,
        date: journal.data.date.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        }).replace(/\//g, '-'),
        title: journal.data.title,
        overview: journal.data.overview,
        Content,
      };
    }));

    return {
      params: { slug: entry.id },
      props: { entry, journals },
    };
  }));
}

const { entry, journals } = Astro.props;
const { Content } = await render(entry);
const { data } = entry;

// Prepare journal data for the component (without Content for serialization)
const journalData = journals.map(({ id, date, title, overview }) => ({ id, date, title, overview }));
---

<BaseLayout title={data.title} description={data.description} hideModel>
  <ProductArticle
    title={data.title}
    description={data.description}
    tags={data.tags}
    status={data.status}
    icon={data.icon}
    github={data.github}
    demo={data.demo}
    opensource={data.opensource}
    features={data.features}
    journals={journalData}
  >
    <Content />

    <Comments slot="after" />
  </ProductArticle>

  <!-- Hidden journal content containers for overlay -->
  {journals.map((journal) => (
    <template data-journal-content={journal.id} data-date={journal.date} data-title={journal.title}>
      <journal.Content />
    </template>
  ))}

  <JournalOverlay />
</BaseLayout>

<script>
  import { fetchGitHubStars } from '../../utils/github-stars';

  function initJournalEntries() {
    document.querySelectorAll('.journey-card[data-journal-id]').forEach(entry => {
      entry.addEventListener('click', () => {
        const journalId = entry.getAttribute('data-journal-id');
        if (!journalId) return;

        const template = document.querySelector(`template[data-journal-content="${journalId}"]`) as HTMLTemplateElement;
        if (!template) return;

        const { date, title } = template.dataset;
        if (typeof window.openJournalOverlay === 'function') {
          window.openJournalOverlay({ date: date || '', title: title || '', content: template.innerHTML });
        }
      });
    });
  }

  function initScrollIndicator() {
    const journey = document.querySelector('.journey') as HTMLElement;
    const indicator = document.querySelector('.scroll-indicator') as HTMLElement;
    if (!journey || !indicator) return;

    function updateIndicator() {
      const isScrollable = journey.scrollHeight > journey.clientHeight;
      const isAtBottom = journey.scrollTop + journey.clientHeight >= journey.scrollHeight - 10;
      indicator.classList.toggle('visible', isScrollable && !isAtBottom);
    }

    updateIndicator();
    journey.addEventListener('scroll', updateIndicator);
    window.addEventListener('resize', updateIndicator);
  }

  fetchGitHubStars();
  initJournalEntries();
  initScrollIndicator();
  document.addEventListener('astro:after-swap', () => {
    fetchGitHubStars();
    initJournalEntries();
    initScrollIndicator();
  });
</script>
