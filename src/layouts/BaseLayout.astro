---
// Learn about using Astro layouts:
// https://docs.astro.build/en/core-concepts/layouts/

import { ViewTransitions } from 'astro:transitions';
import BottomTabBar from '../components/layout/BottomTabBar.astro';
import Footer from '../components/layout/Footer.astro';
// Component Imports
import MainHead from '../components/layout/MainHead.astro';
import Nav from '../components/layout/Nav.astro';
import BackToTop from '../components/ui/BackToTop.astro';
import Island3DScene from '../components/three/Island3DScene.astro';

interface Props {
	title?: string | undefined;
	description?: string | undefined;
	hideIsland?: boolean;
}

const { title, description, hideIsland = false } = Astro.props;
---

<html lang="en" class="theme-dark">
	<head>
		<MainHead title={title} description={description} />
		<ViewTransitions />
		<script is:inline>
			function applyTheme() {
				const theme = localStorage.getItem('theme');
				if (!theme) {
					// Default to dark theme
					localStorage.setItem('theme', 'dark');
					document.documentElement.classList.add('theme-dark');
				} else if (theme === 'dark') {
					document.documentElement.classList.add('theme-dark');
				} else {
					document.documentElement.classList.remove('theme-dark');
				}
			}
			applyTheme();
			document.addEventListener('astro:after-swap', applyTheme);
		</script>
	</head>
	<body>
		<Nav />
		{!hideIsland && (
			<div class="island-wrapper" transition:persist="island3d" transition:animate="none">
				<Island3DScene />
			</div>
		)}
		<div class="stack backgrounds">
			<main class="main-content">
				<slot />
			</main>
			<Footer />
		</div>
		<BottomTabBar />
		<BackToTop />

		<script>
			let scrollAnimationId: number | null = null;
			let isAutoScrolling = false;

			function cancelAutoScroll() {
				if (scrollAnimationId !== null) {
					cancelAnimationFrame(scrollAnimationId);
					scrollAnimationId = null;
				}
				isAutoScrolling = false;
			}

			function smoothScrollTo(targetY: number, duration: number) {
				cancelAutoScroll();

				const startY = window.scrollY;
				const distance = targetY - startY;
				const startTime = performance.now();
				isAutoScrolling = true;

				function easeInOutCubic(t: number): number {
					return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
				}

				function step(currentTime: number) {
					if (!isAutoScrolling) return;

					const elapsed = currentTime - startTime;
					const progress = Math.min(elapsed / duration, 1);
					window.scrollTo(0, startY + distance * easeInOutCubic(progress));

					if (progress < 1) {
						scrollAnimationId = requestAnimationFrame(step);
					} else {
						isAutoScrolling = false;
						scrollAnimationId = null;
					}
				}

				scrollAnimationId = requestAnimationFrame(step);
			}

			// Cancel auto-scroll if user interacts
			['wheel', 'touchstart', 'keydown'].forEach(event => {
				window.addEventListener(event, () => {
					if (isAutoScrolling) cancelAutoScroll();
				}, { passive: true });
			});

			function scrollToTitle() {
				// Guard: Skip if home page
				if (window.location.pathname === '/') return;

				// Guard: Skip if hash navigation (preserve anchor behavior)
				if (window.location.hash) return;

				// Find title element
				const title = document.querySelector('h1.title');
				if (!title) return; // Graceful exit if no title (404, etc.)

				// Smooth scroll to title (1.5 seconds)
				const targetY = title.getBoundingClientRect().top + window.scrollY;
				smoothScrollTo(targetY, 1500);
			}

			// On initial load: scroll to top first, wait for 3D spin, then scroll to title
			if (window.location.pathname !== '/') {
				window.scrollTo(0, 0);
				setTimeout(scrollToTitle, 2000);
			}
			// Run on View Transitions navigation (no delay needed)
			document.addEventListener('astro:page-load', scrollToTitle);
		</script>

		<script>
			// Add "loaded" class once the document has completely loaded.
			addEventListener('load', () => document.documentElement.classList.add('loaded'));
		</script>

		<style>
			.island-wrapper {
				max-width: 500px;
				margin: 0 auto;
				padding: 0 1.5rem;
				/* Move island up to overlap the nav bar area */
				margin-top: -3.8rem;
			}

			@media (min-width: 50em) {
				.island-wrapper {
					margin-top: -4.7rem;
				}
			}

			.backgrounds {
				min-height: 100vh;
				isolation: isolate;
				background-color: var(--gray-999);
				display: flex;
				flex-direction: column;
				/* Add padding for floating bottom tab bar */
				padding-bottom: calc(4.5rem + env(safe-area-inset-bottom, 0px));
			}

			.main-content {
				flex: 1;
			}
		</style>
	</body>
</html>
