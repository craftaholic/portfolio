---
/**
 * 3D Island scene with loading indicator
 * Shows a spinning loader while Three.js initializes
 */
---

<div id="island-3d-container" class="island-container">
  <div id="island-loader" class="loader">
    <div class="spinner"></div>
    <span class="loader-text">Loading 3D scene...</span>
  </div>
</div>

<script>
  import { Island3D } from './Island3D';

  // Use a global to persist across View Transitions
  declare global {
    interface Window {
      __island3D?: Island3D | null;
    }
  }

  function initIsland3D() {
    const container = document.getElementById('island-3d-container');
    const loader = document.getElementById('island-loader');

    if (!container) return null;

    // Check if canvas already exists in DOM (element was properly persisted)
    const existingCanvas = container.querySelector('canvas');
    if (existingCanvas && window.__island3D) {
      // Canvas is present and instance exists - just hide loader
      if (loader) {
        loader.classList.add('hidden');
      }
      return window.__island3D;
    }

    // If we have a stale reference but no canvas, clean it up
    if (window.__island3D && !existingCanvas) {
      window.__island3D.dispose();
      window.__island3D = null;
    }

    // Wait for container to have dimensions (may be 0 during prefetch)
    if (container.clientWidth === 0 || container.clientHeight === 0) {
      // Retry after a short delay
      requestAnimationFrame(() => initIsland3D());
      return null;
    }

    let island3D: Island3D | null = null;

    island3D = new Island3D(container, {
      onLoad: () => {
        // Hide loader when scene is ready
        if (loader) {
          loader.classList.add('hidden');
        }
      },
    });
    // Store globally
    window.__island3D = island3D;

    return island3D;
  }

  // Initialize on first load
  initIsland3D();

  // Re-initialize after page swap if needed (when returning from hideIsland pages)
  document.addEventListener('astro:after-swap', () => {
    requestAnimationFrame(() => {
      initIsland3D();
    });
  });
</script>

<style>
  .island-container {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    height: 320px;
    border-radius: 1.5rem;
    overflow: hidden;
    background: transparent;
    cursor: grab;
    position: relative;
  }

  .island-container:active {
    cursor: grabbing;
  }

  .island-container canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  .loader {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    background: transparent;
    border-radius: inherit;
    transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    z-index: 10;
  }

  .loader.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--gray-700);
    border-top-color: var(--accent-regular);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .loader-text {
    font-size: var(--text-sm);
    color: var(--gray-400);
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Scale down for very small screens */
  @media (max-width: 400px) {
    .island-container {
      height: 260px;
      border-radius: 1.25rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
    }

    .loader-text {
      font-size: 0.75rem;
    }
  }

  @media (max-width: 340px) {
    .island-container {
      height: 220px;
      border-radius: 1rem;
    }

    .spinner {
      width: 32px;
      height: 32px;
    }
  }

  @media (min-width: 50em) {
    .island-container {
      height: 380px;
      border-radius: 4.5rem;
    }

    .spinner {
      width: 56px;
      height: 56px;
      border-width: 4px;
    }
  }
</style>
