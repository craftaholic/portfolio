---
/**
 * 3D Model scene with loading indicator
 * Shows a spinning loader while Three.js initializes
 */
---

<div id="model-3d-container" class="model-container">
  <div id="model-drag-zone" class="drag-zone"></div>
  <div id="model-loader" class="loader">
    <div class="spinner"></div>
    <span class="loader-text">Loading 3D scene...</span>
  </div>
</div>

<script>
  import { Model3D } from './Model3D';

  declare global {
    interface Window {
      __model3D?: Model3D | null;
    }
  }

  function initModel3D() {
    const container = document.getElementById('model-3d-container');
    const loader = document.getElementById('model-loader');

    if (!container) return null;

    const existingCanvas = container.querySelector('canvas');
    if (existingCanvas && window.__model3D) {
      if (loader) {
        loader.classList.add('hidden');
      }
      return window.__model3D;
    }

    if (window.__model3D && !existingCanvas) {
      window.__model3D.dispose();
      window.__model3D = null;
    }

    if (container.clientWidth === 0 || container.clientHeight === 0) {
      requestAnimationFrame(() => initModel3D());
      return null;
    }

    const model3D = new Model3D(container, {
      onLoad: () => {
        if (loader) {
          loader.classList.add('hidden');
        }
      },
    });

    window.__model3D = model3D;
    return model3D;
  }

  initModel3D();

  document.addEventListener('astro:after-swap', () => {
    requestAnimationFrame(() => {
      initModel3D();
    });
  });
</script>

<style>
  .model-container {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    height: 320px;
    border-radius: 1.5rem;
    overflow: visible;
    background: transparent;
    cursor: grab;
    position: relative;
    transition: filter var(--transition-normal);
  }

  .model-container.hovered {
    filter: drop-shadow(0 0 20px var(--model-glow-color))
            drop-shadow(0 0 40px var(--model-glow-color-subtle));
  }

  .model-container:active {
    cursor: grabbing;
  }

  .model-container canvas {
    display: block;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .drag-zone {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    height: 60%;
    z-index: 5;
    cursor: grab;
    border-radius: 50%;
    touch-action: none;
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  .drag-zone:active {
    cursor: grabbing;
  }

  .loader {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    background: transparent;
    border-radius: inherit;
    transition: opacity var(--transition-normal), visibility var(--transition-normal);
    z-index: 10;
  }

  .loader.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--gray-700);
    border-top-color: var(--accent-regular);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .loader-text {
    font-size: var(--text-sm);
    color: var(--gray-400);
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 400px) {
    .model-container {
      height: 260px;
      border-radius: 1.25rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
    }

    .loader-text {
      font-size: 0.75rem;
    }
  }

  @media (max-width: 340px) {
    .model-container {
      height: 220px;
      border-radius: 1rem;
    }

    .spinner {
      width: 32px;
      height: 32px;
    }
  }

  @media (min-width: 50em) {
    .model-container {
      height: 380px;
      border-radius: 4.5rem;
    }

    .spinner {
      width: 56px;
      height: 56px;
      border-width: 4px;
    }
  }
</style>
