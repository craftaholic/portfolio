---
import { NAV_LINKS } from '../../config';
import { isCurrentPage } from '../../utils/navigation';

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, '');
---

<nav class="bottom-tab-bar" aria-label="Mobile navigation">
	<ul class="tab-list">
		<li class="tab-indicator" aria-hidden="true"></li>
		{
			NAV_LINKS.map(({ label, href }) => (
				<li>
					<a
						href={href}
						class:list={['tab-item', { active: isCurrentPage(pathname, href) }]}
						aria-current={isCurrentPage(pathname, href) ? 'page' : undefined}
					>
						{label}
					</a>
				</li>
			))
		}
	</ul>
</nav>

<script>
	// Sliding tab indicator - uses transform for smooth GPU-accelerated animation
	function moveTabIndicatorTo(targetLink: HTMLElement, animate = true) {
		const tabList = document.querySelector('.bottom-tab-bar .tab-list') as HTMLElement;
		const indicator = document.querySelector('.bottom-tab-bar .tab-indicator') as HTMLElement;

		if (!tabList || !indicator || !targetLink) return;

		const listRect = tabList.getBoundingClientRect();
		const targetRect = targetLink.getBoundingClientRect();

		const x = targetRect.left - listRect.left;
		const y = targetRect.top - listRect.top;

		if (animate) {
			indicator.style.transition = 'transform 0.35s var(--nav-easing), width 0.35s var(--nav-easing), height 0.35s var(--nav-easing)';
		} else {
			indicator.style.transition = 'none';
		}

		indicator.style.width = `${targetRect.width}px`;
		indicator.style.height = `${targetRect.height}px`;
		indicator.style.transform = `translate(${x}px, ${y}px)`;
		indicator.style.opacity = '1';
	}

	function initTabIndicator() {
		const activeLink = document.querySelector('.bottom-tab-bar .tab-item[aria-current="page"]') as HTMLElement;
		if (activeLink) {
			moveTabIndicatorTo(activeLink, false);
		}
	}

	// Update active state based on URL
	function updateTabActiveState() {
		const links = document.querySelectorAll('.bottom-tab-bar .tab-item');
		if (!links.length) return;

		let pathname = window.location.pathname;
		if (pathname.at(0) !== '/') pathname = '/' + pathname;
		if (pathname.at(-1) !== '/') pathname += '/';

		links.forEach(link => {
			const href = link.getAttribute('href') || '';
			const isActive = pathname === href || (href !== '/' && pathname.startsWith(href));
			if (isActive) {
				link.setAttribute('aria-current', 'page');
				link.classList.add('active');
			} else {
				link.removeAttribute('aria-current');
				link.classList.remove('active');
			}
		});

		// Update indicator position without animation
		const activeLink = document.querySelector('.bottom-tab-bar .tab-item[aria-current="page"]') as HTMLElement;
		if (activeLink) {
			moveTabIndicatorTo(activeLink, false);
		}
	}

	// Use event delegation - attach to document once, works for all current and future elements
	document.addEventListener('click', (e) => {
		const link = (e.target as HTMLElement).closest('.bottom-tab-bar .tab-item') as HTMLElement;
		if (link) {
			moveTabIndicatorTo(link, true);
		}
	});

	// Initialize
	initTabIndicator();

	// Update on resize (debounced)
	let tabResizeTimeout: number;
	window.addEventListener('resize', () => {
		clearTimeout(tabResizeTimeout);
		tabResizeTimeout = window.setTimeout(updateTabActiveState, 100);
	});

	// Update after page swap
	document.addEventListener('astro:after-swap', () => {
		updateTabActiveState();
	});
</script>

<style>
	.bottom-tab-bar {
		display: flex;
		justify-content: center;
		position: fixed;
		bottom: 1rem;
		bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
		left: 50%;
		transform: translateX(-50%);
		z-index: 9999;
		/* Prevent disappearing during view transitions */
		view-transition-name: bottom-tab-bar;
	}

	/* Disable animation for this element during transitions */
	::view-transition-old(bottom-tab-bar),
	::view-transition-new(bottom-tab-bar) {
		animation: none;
		mix-blend-mode: normal;
	}

	.tab-list {
		position: relative;
		display: flex;
		align-items: center;
		list-style: none;
		margin: 0;
		padding: 0.5rem 0.5625rem;
		gap: 0.25rem;
		background: radial-gradient(var(--gray-900), var(--gray-800) 150%);
		border-radius: 999rem;
		box-shadow: var(--shadow-md);
	}

	/* Gradient border like desktop nav */
	.tab-list::before {
		position: absolute;
		inset: -1px;
		content: '';
		background: var(--gradient-stroke);
		border-radius: 999rem;
		z-index: -1;
	}

	.tab-indicator {
		position: absolute;
		top: 0;
		left: 0;
		background-color: var(--accent-regular);
		border-radius: 999rem;
		opacity: 0;
		z-index: 0;
		pointer-events: none;
		will-change: transform, width, height;
	}

	.tab-item {
		position: relative;
		z-index: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0.5rem 0.75rem;
		font-size: var(--text-sm);
		font-weight: 500;
		color: var(--gray-300);
		text-decoration: none;
		border-radius: 999rem;
		transition: color var(--theme-transition);
		white-space: nowrap;
	}

	.tab-item:hover,
	.tab-item:focus {
		color: var(--gray-100);
	}

	.tab-item.active {
		color: var(--accent-text-over);
	}

	/* Hide on desktop */
	@media (min-width: 50em) {
		.bottom-tab-bar {
			display: none;
		}
	}
</style>
