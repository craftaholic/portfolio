---
import BackLink from '../ui/BackLink.astro';
import Pill from '../ui/Pill.astro';
import PageContainer from '../layout/PageContainer.astro';
import Accordion from '../ui/Accordion.astro';
import Icon from '../ui/Icon.astro';
import MarkdownContent from '../ui/MarkdownContent.astro';
import JournalTimeline from './JournalTimeline.astro';
import { STATUS_LABELS, STATUS_CLASSES } from '../../utils/product-status';
import type { ProductStatus } from '../../utils/product-status';

interface JournalEntry {
  id: string;
  date: string;
  title: string;
  overview: string;
}

interface Props {
  title: string;
  description: string;
  tags: string[];
  status: ProductStatus;
  icon?: string;
  github?: string;
  demo?: string;
  opensource?: boolean;
  features?: string[];
  journals?: JournalEntry[];
}

const { title, description, tags, status, icon, github, demo, opensource, features, journals = [] } = Astro.props;
---

<PageContainer>
  <article class="product-detail">
    <BackLink href="/products/" label="Products" />

    <header class="header">
      <div class="header-top">
        {icon && <span class="icon">{icon}</span>}
        <span class:list={['status-badge', STATUS_CLASSES[status]]}>{STATUS_LABELS[status]}</span>
      </div>
      <h1 class="title">{title}</h1>
      <p class="description">{description}</p>

      <div class="tags">
        {tags.map((t) => <Pill size="sm">{t}</Pill>)}
      </div>

      <div class="links">
        {github && (
          <a href={github} target="_blank" rel="noopener noreferrer" class="link-btn">
            <svg class="link-icon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            {opensource ? (
              <span class="github-stars" data-repo={github}>
                <svg class="star-icon" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                  <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"/>
                </svg>
                <span class="star-count">-</span>
              </span>
            ) : (
              <span class="private-badge">
                <svg class="lock-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor">
                  <path d="M4 4v2h-.25A1.75 1.75 0 0 0 2 7.75v5.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0 0 14 13.25v-5.5A1.75 1.75 0 0 0 12.25 6H12V4a4 4 0 1 0-8 0Zm6.5 2V4a2.5 2.5 0 0 0-5 0v2Z"/>
                </svg>
                Private
              </span>
            )}
          </a>
        )}
        {demo && (
          <a href={demo} target="_blank" rel="noopener noreferrer" class="link-btn link-btn-primary">
            Live Demo
          </a>
        )}
      </div>
    </header>

    <div class="sections">
      {journals.length > 0 && (
        <>
          <button class="journal-trigger" type="button">
            <span class="journal-trigger-left">
              <Icon icon="notebook" size="1.25em" />
              <span class="journal-trigger-title">Development Journal</span>
            </span>
            <span class="journal-trigger-meta">
              <span class="journal-count">{journals.length} {journals.length === 1 ? 'log' : 'logs'}</span>
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </span>
          </button>
          <JournalTimeline journals={journals} />
        </>
      )}

      <Accordion title="Overview" defaultOpen>
        <MarkdownContent>
          <slot />
        </MarkdownContent>
      </Accordion>

      {features && features.length > 0 && (
        <Accordion title="Features">
          <ul class="features-list">
            {features.map((feature) => (
              <li>{feature}</li>
            ))}
          </ul>
        </Accordion>
      )}
    </div>

    <slot name="after" />
  </article>
</PageContainer>

<style>
  .header {
    margin-top: 1rem;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--gray-800);
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .icon {
    font-size: 2.5rem;
  }

  .status-badge {
    font-size: var(--text-xs);
    font-weight: 500;
    padding: 0.25rem 0.625rem;
    border-radius: 999rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .status-mature {
    background: var(--status-mature-bg);
    color: var(--status-mature-text);
  }

  .status-wip {
    background: var(--status-wip-bg);
    color: var(--status-wip-text);
  }

  .status-archived {
    background: var(--status-archived-bg);
    color: var(--status-archived-text);
  }

  .title {
    font-size: var(--text-2xl);
    color: var(--gray-0);
    margin-bottom: 1rem;
  }

  .description {
    font-size: var(--text-md);
    color: var(--gray-300);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .links {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .link-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: var(--text-sm);
    font-weight: 500;
    text-decoration: none;
    border-radius: 999rem;
    border: 1px solid var(--gray-700);
    color: var(--gray-300);
    transition: border-color var(--theme-transition), color var(--theme-transition);
  }

  .link-btn:hover {
    border-color: var(--accent-regular);
    color: var(--accent-regular);
  }

  .link-icon {
    flex-shrink: 0;
  }

  .github-stars {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: var(--text-xs);
    color: var(--gray-400);
  }

  .star-icon {
    color: var(--gray-400);
  }

  .private-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: var(--text-xs);
    color: var(--gray-500);
  }

  .lock-icon {
    color: var(--gray-500);
  }

  .link-btn-primary {
    background: var(--accent-regular);
    border-color: var(--accent-regular);
    color: var(--accent-text-over);
  }

  .link-btn-primary:hover {
    background: var(--accent-light);
    border-color: var(--accent-light);
    color: var(--accent-text-over);
  }

  .sections {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .features-list {
    padding-left: 1.25rem;
    margin: 0;
  }

  .features-list li {
    margin-bottom: 0.5rem;
    color: var(--gray-200);
  }

  .journal-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 1rem 1.25rem;
    background: var(--accent-overlay);
    border: 1px solid var(--accent-regular);
    border-radius: 0.5rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s ease, box-shadow 0.15s ease;
    position: relative;
  }

  .journal-trigger::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow: 0 0 20px var(--accent-overlay), inset 0 0 10px var(--accent-overlay);
    pointer-events: none;
  }

  .journal-trigger:hover {
    background: var(--accent-dark);
    box-shadow: 0 0 24px var(--accent-overlay);
  }

  .journal-trigger-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent-light);
  }

  .journal-trigger-title {
    font-size: var(--text-base);
    font-weight: 600;
  }

  .journal-trigger-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent-regular);
  }

  .journal-count {
    font-size: var(--text-sm);
    opacity: 0.8;
  }

  .journal-trigger-meta svg {
    transition: transform 0.15s ease;
  }

  .journal-trigger:hover .journal-trigger-meta svg {
    transform: translateX(3px);
  }

  @media (min-width: 50em) {
    .title {
      font-size: var(--text-3xl);
    }

    .description {
      font-size: var(--text-lg);
    }
  }
</style>

<script>
  function initJournalTrigger() {
    const trigger = document.querySelector('.journal-trigger');
    if (!trigger) return;

    trigger.addEventListener('click', () => {
      if (window.openJournalTimeline) {
        window.openJournalTimeline();
      }
    });
  }

  initJournalTrigger();
  document.addEventListener('astro:after-swap', initJournalTrigger);
</script>
