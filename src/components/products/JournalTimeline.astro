---
interface JournalEntry {
  id: string;
  date: string;
  title: string;
  overview: string;
}

interface Props {
  journals: JournalEntry[];
}

const { journals } = Astro.props;
---

<div class="journal-timeline-overlay" id="journal-timeline-overlay" aria-hidden="true">
  <div class="timeline-backdrop"></div>
  <div class="timeline-content">
    <div class="timeline-header">
      <h2 class="timeline-title">Development Timeline</h2>
      <button class="close-btn" aria-label="Close timeline">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="timeline-body">
      <div class="calendar-section">
        <div class="calendar-nav-header">
          <button class="cal-nav cal-prev" type="button" aria-label="Previous month">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <span class="cal-month-label"></span>
          <button class="cal-nav cal-next" type="button" aria-label="Next month">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
        <div class="calendar-weekdays">
          <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
        </div>
        <div class="calendar-grid"></div>
      </div>

      <div class="entries-section">
        <h3 class="entries-title">Entries</h3>
        <div class="entries-list">
          {journals.map((journal) => (
            <button
              class="entry-item"
              data-journal-id={journal.id}
              data-journal-date={journal.date}
              type="button"
            >
              <span class="entry-date">{journal.date}</span>
              <span class="entry-title">{journal.title}</span>
              <p class="entry-overview">{journal.overview}</p>
            </button>
          ))}
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ journals }}>
  function initJournalTimeline() {
    const overlay = document.getElementById('journal-timeline-overlay');
    if (!overlay) return;

    const backdrop = overlay.querySelector('.timeline-backdrop');
    const closeBtn = overlay.querySelector('.close-btn');
    const calGrid = overlay.querySelector('.calendar-grid');
    const monthLabel = overlay.querySelector('.cal-month-label');
    const prevBtn = overlay.querySelector('.cal-prev');
    const nextBtn = overlay.querySelector('.cal-next');
    const entriesList = overlay.querySelector('.entries-list');

    if (!backdrop || !closeBtn || !calGrid || !monthLabel || !prevBtn || !nextBtn) return;

    // Parse journal dates (DD-MM-YYYY to Date objects)
    const journalDates = journals.map(j => {
      const [day, month, year] = j.date.split('-');
      return { ...j, dateObj: new Date(year, month - 1, day) };
    });

    // Find the most recent date to start
    const sortedByDate = [...journalDates].sort((a, b) => b.dateObj - a.dateObj);
    const latestDate = sortedByDate[0]?.dateObj || new Date();
    let currentMonth = latestDate.getMonth();
    let currentYear = latestDate.getFullYear();

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];

    function hasEntryOnDate(year, month, day) {
      return journalDates.some(j =>
        j.dateObj.getFullYear() === year &&
        j.dateObj.getMonth() === month &&
        j.dateObj.getDate() === day
      );
    }

    function getEntryForDate(year, month, day) {
      return journalDates.find(j =>
        j.dateObj.getFullYear() === year &&
        j.dateObj.getMonth() === month &&
        j.dateObj.getDate() === day
      );
    }

    function renderCalendar() {
      monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      calGrid.innerHTML = '';

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

      // Empty cells for days before the first
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('span');
        empty.className = 'cal-day empty';
        calGrid.appendChild(empty);
      }

      // Day cells
      for (let d = 1; d <= lastDate; d++) {
        const dayEl = document.createElement('button');
        dayEl.type = 'button';
        dayEl.className = 'cal-day';
        dayEl.textContent = d;

        if (hasEntryOnDate(currentYear, currentMonth, d)) {
          dayEl.classList.add('has-entry');
          dayEl.addEventListener('click', () => {
            const entry = getEntryForDate(currentYear, currentMonth, d);
            if (entry) highlightEntry(entry.id);
          });
        }

        calGrid.appendChild(dayEl);
      }
    }

    function highlightEntry(id) {
      const items = entriesList.querySelectorAll('.entry-item');
      items.forEach(item => item.classList.remove('highlighted'));

      const target = entriesList.querySelector(`[data-journal-id="${id}"]`);
      if (target) {
        target.classList.add('highlighted');
        target.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // Sync calendar to visible entries on scroll
    function setupScrollSync() {
      const entriesSection = overlay.querySelector('.entries-section');
      if (!entriesSection || !entriesList) return;

      let scrollTimeout;
      let isScrollListenerAttached = entriesSection.dataset.scrollSyncAttached;
      if (isScrollListenerAttached) return;
      entriesSection.dataset.scrollSyncAttached = 'true';

      entriesSection.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          const items = entriesList.querySelectorAll('.entry-item');
          const sectionRect = entriesSection.getBoundingClientRect();
          let firstFullyVisible = null;

          for (const item of items) {
            const rect = item.getBoundingClientRect();
            // Check if item's top is at or below the section's top (fully visible)
            if (rect.top >= sectionRect.top - 1) {
              firstFullyVisible = item;
              break;
            }
          }

          if (firstFullyVisible) {
            const dateStr = firstFullyVisible.dataset.journalDate;
            if (dateStr) {
              const [day, month, year] = dateStr.split('-');
              const entryMonth = parseInt(month, 10) - 1;
              const entryYear = parseInt(year, 10);

              // Only update if month changed
              if (entryMonth !== currentMonth || entryYear !== currentYear) {
                currentMonth = entryMonth;
                currentYear = entryYear;
                renderCalendar();
              }
            }
          }
        }, 50); // Debounce scroll events
      });
    }

    function openTimeline() {
      overlay.classList.add('active');
      overlay.setAttribute('aria-hidden', 'false');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      renderCalendar();
    }

    function closeTimeline() {
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    backdrop.addEventListener('click', closeTimeline);
    closeBtn.addEventListener('click', closeTimeline);

    prevBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        closeTimeline();
      }
    });

    // Entry click -> open journal overlay
    entriesList?.querySelectorAll('.entry-item').forEach(item => {
      item.addEventListener('click', () => {
        const journalId = item.dataset.journalId;
        if (!journalId) return;

        // Get content from template element (rendered by the page)
        const template = document.querySelector(`template[data-journal-content="${journalId}"]`);
        if (!template || !window.openJournalOverlay) return;

        const { date, title } = template.dataset;
        window.openJournalOverlay({
          date: date || '',
          title: title || '',
          content: template.innerHTML
        });

        // Close timeline when opening journal
        closeTimeline();
      });
    });

    // Setup scroll sync for calendar
    setupScrollSync();

    // Expose globally
    window.openJournalTimeline = openTimeline;
  }

  initJournalTimeline();
  document.addEventListener('astro:after-swap', initJournalTimeline);
</script>

<style>
  .journal-timeline-overlay {
    position: fixed;
    inset: 0;
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .journal-timeline-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .timeline-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .timeline-content {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 480px;
    max-height: 85vh;
    background: var(--gray-900);
    border: 1px solid var(--gray-700);
    border-radius: 1rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.95) translateY(10px);
    transition: transform 0.2s ease;
  }

  .journal-timeline-overlay.active .timeline-content {
    transform: scale(1) translateY(0);
  }

  .timeline-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-800);
  }

  .timeline-title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--gray-0);
    margin: 0;
  }

  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem;
    background: transparent;
    border: 1px solid var(--gray-700);
    border-radius: 0.375rem;
    color: var(--gray-400);
    cursor: pointer;
    transition: color 0.15s ease, border-color 0.15s ease;
  }

  .close-btn:hover {
    color: var(--gray-0);
    border-color: var(--gray-500);
  }

  .timeline-body {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Calendar Section */
  .calendar-section {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-800);
  }

  .calendar-nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .cal-month-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--gray-100);
  }

  .cal-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    background: transparent;
    border: none;
    border-radius: 0.25rem;
    color: var(--gray-400);
    cursor: pointer;
    transition: color 0.15s ease, background 0.15s ease;
  }

  .cal-nav:hover {
    color: var(--gray-0);
    background: var(--gray-800);
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.25rem;
    margin-bottom: 0.5rem;
  }

  .calendar-weekdays span {
    text-align: center;
    font-size: 0.625rem;
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.25rem;
  }

  .calendar-grid :global(.cal-day) {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-family: inherit;
    color: var(--gray-500);
    background: transparent;
    border: none;
    border-radius: 0.25rem;
    cursor: default;
  }

  .calendar-grid :global(.cal-day.empty) {
    visibility: hidden;
  }

  .calendar-grid :global(.cal-day.has-entry) {
    color: var(--accent-text-over);
    background: var(--accent-regular);
    cursor: pointer;
    font-weight: 600;
    transition: background 0.15s ease, transform 0.15s ease;
  }

  .calendar-grid :global(.cal-day.has-entry:hover) {
    background: var(--accent-light);
    transform: scale(1.1);
  }

  /* Entries Section */
  .entries-section {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
  }

  .entries-title {
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.75rem;
  }

  .entries-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .entry-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    background: var(--gray-800);
    border: 1px solid transparent;
    border-radius: 0.5rem;
    text-align: left;
    font-family: inherit;
    cursor: pointer;
    transition: border-color 0.15s ease, background 0.15s ease;
  }

  .entry-item:hover {
    border-color: var(--gray-600);
  }

  .entry-item.highlighted {
    border-color: var(--accent-regular);
    background: var(--accent-overlay);
  }

  .entry-date {
    font-size: var(--text-xs);
    color: var(--accent-regular);
    font-weight: 500;
  }

  .entry-title {
    font-size: var(--text-sm);
    color: var(--gray-0);
    font-weight: 600;
  }

  .entry-overview {
    font-size: var(--text-xs);
    color: var(--gray-400);
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (min-width: 50em) {
    .timeline-content {
      max-width: 520px;
    }
  }
</style>
